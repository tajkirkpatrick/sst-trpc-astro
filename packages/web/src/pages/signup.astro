---
// src/pages/signup.astro
import Layout from "@/layouts/Layout.astro";
import { auth } from "../lib/lucia";
import { ulid } from "ulid";
import { z } from "zod";
import { DrizzleError } from "drizzle-orm";

// check for form submissions
if (Astro.request.method === "POST") {
  const { username, password } = Object.fromEntries(
    await Astro.request.formData(),
  ) as Record<string, string>;

  // basic check
  const signUpSchema = z.object({
    username: z.string().min(4),
    password: z.string().min(4),
  });

  const result = signUpSchema.safeParse({
    username,
    password,
  });

  if (result.success) {
    try {
      const user = await auth.createUser({
        userId: ulid(),
        key: {
          providerId: "username", // auth method
          providerUserId: result.data.username.toLowerCase(), // unique id when using "username" auth method
          password: result.data.password, // hashed by Lucia
        },
        attributes: {
          username: result.data.username,
        },
      });
      const session = await auth.createSession({
        userId: user.userId,
        attributes: {},
      });
      Astro.locals.auth.setSession(session); // set session cookie
      return Astro.redirect("/", 302); // redirect to profile page
    } catch (e) {
      // this part depends on the database you're using
      // check for unique constraint error in user table

      if (e instanceof DrizzleError)
        console.error("Invalid username or password");

      console.log("Something went wrong wrong during sign up post request");
    }
  } else {
    // ! Handle the invlaid input error
    // Probably toast or modal here
    console.error(result.error);
    console.log("Invalid input");
  }
}

const session = await Astro.locals.auth.validate();
if (session) return Astro.redirect("/profile", 302);
---

<Layout title="Signup">
  <h1>Sign up</h1>
  <form method="POST">
    <label for="username">Username</label>
    <input name="username" id="username" /><br />
    <label for="password">Password</label>
    <input type="password" name="password" id="password" /><br />
    <input type="submit" />
  </form>
</Layout>
