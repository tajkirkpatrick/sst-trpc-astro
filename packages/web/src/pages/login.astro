---
// src/pages/login.astro
import Layout from "@/layouts/Layout.astro";
import { auth } from "../lib/lucia";
import * as z from "zod";
import { DrizzleError } from "drizzle-orm";

// check for form submissions
if (Astro.request.method === "POST") {
  const { username, password } = Object.fromEntries(
    await Astro.request.formData(),
  ) as Record<string, string>;

  // basic check
  const loginSchema = z.object({
    username: z.string().min(4),
    password: z.string().min(4),
  });

  const result = loginSchema.safeParse({
    username,
    password,
  });

  if (result.success) {
    try {
      // find user by key
      // and validate password
      const key = await auth.useKey(
        "username",
        result.data.username.toLocaleLowerCase(),
        result.data.password,
      );
      const session = await auth.createSession({
        userId: key.userId,
        attributes: {},
      });
      Astro.locals.auth.setSession(session); // set session cookie
      return Astro.redirect("/profile", 302); // redirect to profile page
    } catch (e) {
      if (
        e instanceof DrizzleError &&
        (e.message === "AUTH_INVALID_KEY_ID" ||
          e.message === "AUTH_INVALID_PASSWORD")
      ) {
        // user does not exist
        // or invalid password
        console.error("Incorrect username or password");
      } else {
        console.error("An unknown error occurred");
      }
    }
  } else {
    console.error(result.error);
    console.log("Invalid input");
  }
}

const session = await Astro.locals.auth.validate();
if (session) return Astro.redirect("/profile", 302); // redirect to profile page
---

<Layout title="Sign in">
  <h1>Sign in</h1>
  <form method="POST">
    <label for="username">Username</label>
    <input name="username" id="username" /><br />
    <label for="password">Password</label>
    <input type="password" name="password" id="password" /><br />
    <button type="submit">Submit</button>
  </form>
</Layout>
