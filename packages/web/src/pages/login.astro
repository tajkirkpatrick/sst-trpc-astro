---
// src/pages/login.astro
import Layout from "@/layouts/Layout.astro";
import { auth } from "../lib/lucia";
import * as z from "zod";
import { DrizzleError } from "drizzle-orm";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";

// check for form submissions
if (Astro.request.method === "POST") {
  const { username, password } = Object.fromEntries(
    await Astro.request.formData(),
  ) as Record<string, string>;

  // basic check
  const loginSchema = z.object({
    username: z.string().min(4),
    password: z.string().min(4),
  });

  const result = loginSchema.safeParse({
    username,
    password,
  });

  if (result.success) {
    try {
      // find user by key
      // and validate password
      const key = await auth.useKey(
        "username",
        result.data.username.toLocaleLowerCase(),
        result.data.password,
      );
      const session = await auth.createSession({
        userId: key.userId,
        attributes: {},
      });
      Astro.locals.auth.setSession(session); // set session cookie
      return Astro.redirect("/profile", 302); // redirect to profile page
    } catch (e) {
      if (
        e instanceof DrizzleError &&
        (e.message === "AUTH_INVALID_KEY_ID" ||
          e.message === "AUTH_INVALID_PASSWORD")
      ) {
        // user does not exist
        // or invalid password
        console.error("Incorrect username or password");
      } else {
        console.error("An unknown error occurred");
      }
    }
  } else {
    console.error(result.error);
    console.log("Invalid input");
  }
}

const session = await Astro.locals.auth.validate();
if (session) return Astro.redirect("/profile", 302); // redirect to profile page
---

<Layout title="Login">
  <main class="flex min-h-screen w-screen grow flex-row">
    <div class="w-1/2 bg-black">
      <span></span>
    </div>
    <div class="flex w-1/2 flex-col items-center justify-center bg-white">
      <h3 class="-mb-4 scroll-m-20 text-2xl font-extrabold tracking-tight">
        Create an account
      </h3>
      <p
        class="text-sm leading-7 text-muted-foreground [&:not(:first-child)]:mt-6"
      >
        It's free and only takes a minute!
      </p>

      <form method="POST" class="my-0 mt-4 w-full px-20 py-0">
        <Input name="username" id="username" placeholder="username" /><br />
        <Input
          type="password"
          name="password"
          id="password"
          placeholder="password"
        /><br />
        <Button className="w-full font-thin" type="submit">
          Sign In with Username
        </Button>
      </form>
    </div>
  </main>
</Layout>
